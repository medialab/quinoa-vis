"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}Object.defineProperty(exports,"__esModule",{value:!0});var _extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var r in a)Object.prototype.hasOwnProperty.call(a,r)&&(e[r]=a[r])}return e},_createClass=function(){function e(e,t){for(var a=0;a<t.length;a++){var r=t[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,a,r){return a&&e(t.prototype,a),r&&e(t,r),t}}(),_react=require("react"),_react2=_interopRequireDefault(_react),_d3Scale=require("d3-scale"),_d3TimeFormat=require("d3-time-format"),_lodash=require("lodash"),_utils=require("./utils"),_subComponents=require("./subComponents.js");require("./Timeline.scss");var Timeline=function(e){function t(e){_classCallCheck(this,t);var a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return a.pan=a.pan.bind(a),a.zoom=a.zoom.bind(a),a.jump=a.jump.bind(a),a.setViewSpan=a.setViewSpan.bind(a),a.onUserViewChange=(0,_lodash.debounce)(a.onUserViewChange,100),a.state=(0,_utils.computeDataRelatedState)(e.data,e.viewParameters.dataMap,e.viewParameters||{}),a}return _inherits(t,e),_createClass(t,[{key:"componentWillUpdate",value:function(e){if(JSON.stringify(this.props.viewParameters)!==JSON.stringify(e.viewParameters)&&this.setState({viewParameters:e.viewParameters}),JSON.stringify(this.props.data)!==JSON.stringify(e.data)||JSON.stringify(this.props.dataMap)!==JSON.stringify(e.dataMap)){var t=(0,_utils.computeDataRelatedState)(e.data,e.viewParameters.dataMap,e.viewParameters);this.setState(_extends({},t))}}},{key:"onUserViewChange",value:function(e){this.props.onUserViewChange({lastEventType:e,viewParameters:this.state.viewParameters})}},{key:"pan",value:function(e,t){var a=this.state.viewParameters.fromDate+(e?t:-t),r=this.state.viewParameters.toDate+(e?t:-t);this.setViewSpan(a,r,!1),this.onUserViewChange("wheel")}},{key:"zoom",value:function(e){var t=this.state.viewParameters.toDate-this.state.viewParameters.fromDate,a=t/e,r=a-t,i=this.state.viewParameters.fromDate-r/2,s=this.state.viewParameters.toDate+r/2;i>=this.state.timeBoundaries.minimumDateDisplay&&s<=this.state.timeBoundaries.maximumDateDisplay&&(this.setViewSpan(i,s,!1),this.onUserViewChange("zoom"))}},{key:"jump",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=void 0;a=t?this.state.timeBoundaries.minimumDateDisplay+(this.state.timeBoundaries.maximumDateDisplay-this.state.timeBoundaries.minimumDateDisplay)*e.portionY:e;var r=this.state.viewParameters.toDate-this.state.viewParameters.fromDate;this.setViewSpan(a-r/2,a+r/2,!1)}},{key:"setViewSpan",value:function(e,t){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=void 0,i=void 0;a?(r=this.state.timeBoundaries.minimumDateDisplay+(this.state.timeBoundaries.maximumDateDisplay-this.state.timeBoundaries.minimumDateDisplay)*e.portionY,i=this.state.timeBoundaries.minimumDateDisplay+(this.state.timeBoundaries.maximumDateDisplay-this.state.timeBoundaries.minimumDateDisplay)*t.portionY):(r=e,i=t);var s=_extends({},this.state.viewParameters,{fromDate:r,toDate:i});this.setState({viewParameters:s})}},{key:"render",value:function(){var e=this,t=this.props,a=t.allowUserViewChange,r=void 0===a||a,i=t.orientation,s=void 0===i?"portrait":i,n=this.state,o=n.data,p=n.miniScale,c=n.miniTicks,u=n.viewParameters,m=n.periodsClusters,l=n.eventsClusters,f=n.timeBoundaries,d=u.fromDate instanceof Date?u.fromDate.getTime():u.fromDate,_=u.toDate instanceof Date?u.toDate.getTime():u.toDate,y=_-d,h=o.filter(function(e){var t=e.startDate.getTime(),a=e.endDate&&e.endDate.getTime();return t>=d&&t<=_||a&&a>=d&&a<=_}),T=h.filter(function(e){return void 0===e.endDate}),v=y/20,P=(0,_utils.clusterEvents)(T,v),D=m.timeObjects.filter(function(e){var t=e.startDate.getTime(),a=e.endDate&&e.endDate.getTime();return t>=d&&t<=_||a&&a>=d&&a<=_}),w=(0,_d3Scale.scaleLinear)().range([0,100]).domain([d,_]),g=(0,_utils.setTicks)(_-d),b=(0,_d3TimeFormat.timeFormat)(g.format),C=(0,_utils.computeTicks)(d,_),O=function(t){if(t.stopPropagation(),t.preventDefault(),e.props.allowUserViewChange){var a=(_-d)/10,r=t.deltaY>0;r&&_+a<=e.state.timeBoundaries.maximumDateDisplay&&e.pan(!0,a),!r&&d-a>=e.state.timeBoundaries.minimumDateDisplay&&e.pan(!1,a)}},S=function(t){if(t.stopPropagation(),t.preventDefault(),e.props.allowUserViewChange){var a=(_-d)/2,r=t.deltaY>0;r&&_+a<=f.maximumDateDisplay&&e.pan(!0,a),!r&&d-a>=f.minimumDateDisplay&&e.pan(!1,a)}},E=function(){return e.zoom(1.1)},j=function(){return e.zoom(.9)},k=function(){return e.pan(!1,(_-d)/10)},V=function(){return e.pan(!0,(_-d)/10)},B=function(t,a){t&&a&&e.setViewSpan(t,a)},x=function(t,a){e.setViewSpan(t,a,!1)};return _react2.default.createElement("figure",{className:"quinoa-timeline"+("portrait"===s?" portrait":" landscape")},_react2.default.createElement("aside",{onWheel:S,className:"mini-timeline"},_react2.default.createElement(_subComponents.TimeTicks,{ticks:c,scale:p}),_react2.default.createElement(_subComponents.Brush,{onSimpleClick:this.jump,scale:p,fromDate:u.fromDate,toDate:u.toDate,active:r,onSpanEventDefinition:B,onSpanAbsoluteDefinition:x}),_react2.default.createElement("div",{className:"time-objects-container"},_react2.default.createElement(_subComponents.ClustersGroup,{viewParameters:u,scale:p,clusters:m}),_react2.default.createElement(_subComponents.ClustersGroup,{viewParameters:u,scale:p,clusters:l}))),_react2.default.createElement("section",{className:"main-timeline",onWheel:O},_react2.default.createElement(_subComponents.TimeTicks,{ticks:C,scale:w}),_react2.default.createElement("div",{className:"time-objects-container"},D.length?_react2.default.createElement(_subComponents.ClustersGroup,{viewParameters:u,scale:w,clusters:{columns:m.columns,timeObjects:D}}):"",P.timeObjects.length?_react2.default.createElement(_subComponents.ClustersGroup,{viewParameters:u,scale:w,clusters:P}):""),r?_react2.default.createElement(_subComponents.Controls,{zoomIn:E,zoomOut:j,panForward:V,panBackward:k}):"",_react2.default.createElement("div",{className:"time-boundaries-container"},_react2.default.createElement("div",{id:"from-date"},b(new Date(d))),_react2.default.createElement("div",{id:"to-date"},b(new Date(_))))))}}]),t}(_react2.default.Component);Timeline.propTypes={viewParameters:_react.PropTypes.shape({dataMap:_react.PropTypes.shape({name:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),category:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),year:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),month:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),day:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),time:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),endYear:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),endMonth:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),endDay:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func]),endTime:_react.PropTypes.oneOfType([_react.PropTypes.string,_react.PropTypes.func])}),fromDate:_react.PropTypes.oneOfType([_react.PropTypes.instanceOf(Date),_react.PropTypes.number]),toDate:_react.PropTypes.oneOfType([_react.PropTypes.instanceOf(Date),_react.PropTypes.number]),orientation:_react.PropTypes.oneOf(["landscape","portrait"]).required}),allowUserViewChange:_react.PropTypes.bool,onUserViewChange:_react.PropTypes.func},exports.default=Timeline;